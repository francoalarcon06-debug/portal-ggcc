<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Portal Admin - Gastos Comunes</title>
  <style>
    body {
      font-family: system-ui, Arial, sans-serif;
      background: #f6f7f9;
      margin: 0;
      padding: 40px;
      display: flex;
      justify-content: center;
    }
    .card {
      background: #fff;
      width: 100%;
      max-width: 720px;
      padding: 28px;
      border-radius: 10px;
      box-shadow: 0 10px 30px rgba(0,0,0,.08);
    }
    h1 { margin-top: 0; }
    .step-title { margin: 18px 0 6px; font-weight: 800; }
    label { display:block; margin-top:16px; font-weight:600; }
    input {
      width: 100%;
      margin-top: 6px;
      padding: 10px;
      font-size: 15px;
      box-sizing: border-box;
    }
    button {
      margin-top: 22px;
      width: 100%;
      padding: 12px;
      font-size: 16px;
      cursor: pointer;
    }
    .ok { color: #0a7a0a; margin-top: 14px; }
    .err { color: #b00020; margin-top: 14px; }
    .warn { color: #8a5b00; margin-top: 14px; }
    .hint { font-size: 13px; color: #555; margin-top: 8px; line-height: 1.35; }
    .box {
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      padding: 12px;
      border-radius: 10px;
      margin-top: 10px;
    }
    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 640px) {
      body { padding: 18px; }
      .row { grid-template-columns: 1fr; }
    }
    .disabled {
      opacity: 0.6;
      pointer-events: none;
    }
    code { background: #eef2ff; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>

<body>
  <div class="card">
    <h1>Subir Gastos Comunes</h1>

    <div class="hint">
      <b>Formato recomendado:</b> <code>Colilla_2025-10_dpto_308.pdf</code><br/>
      <b>También acepta:</b> <code>Colilla2025-10-edificiomilano-308.pdf</code><br/>
      Se extrae automáticamente: <b>Período</b> + <b>Departamento</b> (y si existe, un <b>identificador</b> de edificio).
    </div>

    <form id="f">
      <div class="step-title">1) Seleccioná el PDF</div>
      <div class="box">
        <label>Archivo PDF</label>
        <input id="pdf" name="pdf" type="file" accept="application/pdf" required />
        <div class="hint" id="filenameHint"></div>
      </div>

      <div class="step-title">2) Verificá / corregí datos</div>
      <div id="step2" class="box disabled">
        <div class="row">
          <div>
            <label>Período</label>
            <input id="period" name="period" type="month" required />
            <div class="hint">Ej: 2025-10</div>
          </div>

          <div>
            <label>Departamento</label>
            <input id="department_code" name="department_code" required placeholder="308" inputmode="numeric" />
            <div class="hint">Ej: 308</div>
          </div>
        </div>

        <!-- ✅ NUEVO: MONTO GC (auto + editable) -->
        <label>Monto Gasto Común (CLP)</label>
        <input
          id="monto_gc"
          name="monto_gc"
          type="number"
          inputmode="numeric"
          min="0"
          step="1"
          placeholder="Ej: 125430"
        />
        <div class="hint" id="montoHint">
          Monto detectado automáticamente desde el PDF (si es posible). Podés corregirlo si hace falta.
        </div>

        <label>Edificio (opcional por ahora)</label>
        <input id="building" name="building_slug" placeholder="edificiomilano (opcional)" />
        <div class="hint">
          Si después querés que sea obligatorio y/o que sea un ID, lo cambiamos. Por ahora lo dejamos opcional.
        </div>

        <button id="submitBtn" type="submit">Subir PDF</button>
        <div class="hint">
          El archivo quedará asociado al período, departamento y monto seleccionados.
        </div>
      </div>

      <div id="msg"></div>
    </form>
  </div>

  <script>
    // ✅ TU WEBHOOK (TEST) para guardar definitivo
    const N8N_WEBHOOK_URL = "https://n8n.proyectosfranco.cl/webhook-test/subir-ggcc";

    // ✅ NUEVO: webhook "preview" (detecta monto desde el PDF y devuelve JSON)
    // Si todavía no lo creaste, no pasa nada: el front seguirá funcionando sin autocompletar.
    const N8N_PREVIEW_URL = "https://n8n.proyectosfranco.cl/webhook-test/preview-ggcc";

    const form = document.getElementById("f");
    const msg = document.getElementById("msg");

    const pdfInput = document.getElementById("pdf");
    const filenameHint = document.getElementById("filenameHint");

    const step2 = document.getElementById("step2");
    const periodInput = document.getElementById("period");
    const deptInput = document.getElementById("department_code");
    const montoInput = document.getElementById("monto_gc");
    const montoHint = document.getElementById("montoHint");
    const buildingInput = document.getElementById("building");
    const submitBtn = document.getElementById("submitBtn");

    // A) Colilla_2025-10_dpto_308.pdf
    const RX_FORMAT_B = /^Colilla_(\d{4}-\d{2})_dpto_(\d{1,5})(?:\.pdf)?$/i;

    // B) Colilla2025-10-edificiomilano-308.pdf
    const RX_FORMAT_A = /^Colilla(\d{4}-\d{2})(?:-([a-z0-9_]+))?-(\d{1,5})(?:\.pdf)?$/i;

    function setMessage(text, className) {
      msg.textContent = text;
      msg.className = className || "";
    }

    function enableStep2(enable) {
      if (enable) step2.classList.remove("disabled");
      else step2.classList.add("disabled");
    }

    function parseFilename(name) {
      const base = (name || "").split(/[/\\]/).pop();

      let m = base.match(RX_FORMAT_B);
      if (m) {
        return { ok: true, format: "B", period: m[1], dept: m[2], building: "" };
      }

      m = base.match(RX_FORMAT_A);
      if (m) {
        return { ok: true, format: "A", period: m[1], building: m[2] || "", dept: m[3] };
      }

      return { ok: false, base };
    }

    async function safeReadError(res) {
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")) {
        try {
          const j = await res.json();
          return j.message || JSON.stringify(j);
        } catch {
          return "Respuesta JSON inválida del servidor.";
        }
      }
      if (ct.includes("text/html")) return `Error ${res.status} (HTML). Revisá que el webhook exista y el workflow esté en "Listen".`;
      return (await res.text()) || `Error ${res.status}`;
    }

    function normalizeCLPNumber(value) {
      // deja solo números (por si pegás "125.430" o "$125.430")
      const s = String(value ?? "").replace(/[^\d]/g, "");
      return s ? Number(s) : null;
    }

    async function tryPreviewMonto(file) {
      // intenta pedir al webhook de preview el monto detectado
      // respuesta esperada:
      // { "monto_gc": 125430 }  o { "monto_detectado": 125430 }
      const fd = new FormData();
      fd.append("pdf", file);
      fd.append("original_filename", file.name);

      try {
        const res = await fetch(N8N_PREVIEW_URL, { method: "POST", body: fd });
        if (!res.ok) return null;

        const j = await res.json().catch(() => null);
        if (!j || typeof j !== "object") return null;

        const raw = j.monto_gc ?? j.monto_detectado ?? j.monto ?? null;
        const n = normalizeCLPNumber(raw);
        if (n === null || Number.isNaN(n)) return null;

        return n;
      } catch {
        return null;
      }
    }

    pdfInput.addEventListener("change", async () => {
      setMessage("", "");
      enableStep2(false);

      const file = pdfInput.files && pdfInput.files[0];
      if (!file) {
        filenameHint.textContent = "";
        return;
      }

      if (file.type !== "application/pdf") {
        filenameHint.textContent = "";
        setMessage("Error: seleccioná un PDF válido.", "err");
        pdfInput.value = "";
        return;
      }

      const parsed = parseFilename(file.name);

      if (!parsed.ok) {
        filenameHint.innerHTML = `
          <span class="warn"><b>Nombre no reconocido.</b></span><br/>
          Renombrá el archivo a uno de estos formatos:<br/>
          - <code>Colilla_2025-10_dpto_308.pdf</code><br/>
          - <code>Colilla2025-10-edificiomilano-308.pdf</code>
        `;
        setMessage("No puedo extraer datos del nombre. Renombrá el archivo y probá de nuevo.", "err");
        return;
      }

      // Autocompletar campos por nombre
      periodInput.value = parsed.period;
      deptInput.value = parsed.dept;
      buildingInput.value = parsed.building;

      // ✅ reset monto (lo intentamos detectar)
      montoInput.value = "";
      montoHint.textContent = "Detectando monto desde el PDF (si es posible)...";

      filenameHint.innerHTML = `
        <span class="ok"><b>Detectado desde el nombre:</b></span><br/>
        Período: <code>${parsed.period}</code> &nbsp;|&nbsp;
        Depto: <code>${parsed.dept}</code>
        ${parsed.building ? `&nbsp;|&nbsp; Edificio: <code>${parsed.building}</code>` : ""}
      `;

      enableStep2(true);
      setMessage("Revisá los datos y subí el PDF.", "warn");

      // ✅ intentar autocompletar monto desde PDF (no bloquea si falla)
      const monto = await tryPreviewMonto(file);
      if (monto !== null) {
        montoInput.value = String(monto);
        montoHint.textContent = "Monto detectado automáticamente desde el PDF. Podés corregirlo si hace falta.";
      } else {
        montoHint.textContent = "No pude detectar el monto automáticamente. Ingresalo manualmente (podés corregirlo igual).";
      }
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const file = pdfInput.files && pdfInput.files[0];
      if (!file) {
        setMessage("Seleccioná un PDF antes de subir.", "err");
        return;
      }

      if (file.type !== "application/pdf") {
        setMessage("Error: seleccioná un PDF válido.", "err");
        return;
      }

      const period = (periodInput.value || "").trim();
      const dept = (deptInput.value || "").trim();
      const building = (buildingInput.value || "").trim();

      // ✅ monto (opcional, pero recomendado)
      const monto = normalizeCLPNumber(montoInput.value);

      if (!/^\d{4}-\d{2}$/.test(period)) {
        setMessage("Período inválido. Debe ser YYYY-MM (ej: 2025-10).", "err");
        return;
      }

      if (!/^\d{1,5}$/.test(dept)) {
        setMessage("Departamento inválido. Usa solo números (ej: 308).", "err");
        return;
      }

      // si querés hacerlo obligatorio: descomentá esto
      // if (monto === null) {
      //   setMessage("Ingresá el monto del gasto común (CLP).", "err");
      //   return;
      // }

      const fd = new FormData();
      fd.append("pdf", file);
      fd.append("period", period);
      fd.append("department_code", dept);
      fd.append("building_slug", building);
      fd.append("original_filename", file.name);

      if (monto !== null) fd.append("monto_gc", String(monto));

      submitBtn.disabled = true;
      setMessage("Subiendo...", "");

      try {
        const res = await fetch(N8N_WEBHOOK_URL, { method: "POST", body: fd });

        if (!res.ok) {
          const errMsg = await safeReadError(res);
          setMessage("Error: " + errMsg, "err");
          submitBtn.disabled = false;
          return;
        }

        setMessage("✅ PDF cargado correctamente.", "ok");

        // reset
        form.reset();
        enableStep2(false);
        filenameHint.textContent = "";
        montoHint.textContent = "Monto detectado automáticamente desde el PDF (si es posible). Podés corregirlo si hace falta.";
      } catch (err) {
        setMessage("Error de conexión con el servidor.", "err");
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
